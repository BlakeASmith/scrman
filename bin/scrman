#!/usr/bin/env ruby
# frozen_string_literal: true

# Add the lib directory to the load path
lib_dir = File.expand_path('../lib', __dir__)
$LOAD_PATH.unshift(lib_dir) unless $LOAD_PATH.include?(lib_dir)

require 'thor'
require 'helpers'
require 'config'
require 'language'

class Scrman < Thor
  desc "new NAME", "Create a new script"
  option :lang, aliases: :l, type: :string, desc: "the language of the script"
  option :link, aliases: :b, type: :boolean, default: true, desc: "install to the bin"
  option :edit, aliases: :e, type: :boolean, default: true, desc: "open the script in the editor"
  def new(name)
    lang = find_language(options[:lang] || $CONFIG.default_language) || raise("Language #{options[:lang] || $CONFIG.default_language} not found")
    path = lang.path(name)

    ensure_dir lang.scripts_path
    if File.exist? path
      abort "Script #{name} already exists"
    end

    File.write(path, lang.shebang)
    FileUtils.chmod("+x", path)

    if options[:link]
      bin_path = "#{$BIN}/#{name}"
      unless File.exist? bin_path
        FileUtils.ln_s path, bin_path
      end
    end

    if options[:edit]
      open_editor path
    end
  end
end

Scrman.start(ARGV)

